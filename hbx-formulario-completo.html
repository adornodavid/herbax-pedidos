<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Pedidos HBX - Portal Distribuidores</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header p {
            opacity: 0.95;
            font-size: 18px;
        }
        
        /* Stepper */
        .stepper {
            display: flex;
            justify-content: center;
            padding: 30px;
            background: #f9fafb;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin: 0 20px;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e5e7eb;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 10px;
            transition: all 0.3s;
        }
        
        .step.active .step-number {
            background: #10b981;
            color: white;
        }
        
        .step.completed .step-number {
            background: #059669;
            color: white;
        }
        
        .step-title {
            font-weight: 500;
            color: #6b7280;
        }
        
        .step.active .step-title {
            color: #10b981;
            font-weight: 600;
        }
        
        /* Form Sections */
        .form-container {
            padding: 30px;
        }
        
        .form-section {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .form-section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-content {
            background: #f9fafb;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 24px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 500;
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            background: white;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        input.error, select.error {
            border-color: #ef4444;
        }
        
        .error-message {
            color: #ef4444;
            font-size: 13px;
            margin-top: 5px;
            display: none;
        }
        
        .required {
            color: #ef4444;
        }
        
        /* Google Maps */
        #map {
            height: 400px;
            width: 100%;
            border-radius: 8px;
            margin: 20px 0;
            border: 2px solid #e5e7eb;
        }
        
        .map-search-container {
            position: relative;
            margin-bottom: 20px;
        }
        
        #searchAddress {
            padding-left: 40px;
        }
        
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
        }
        
        /* Carrito de Compras */
        .cart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e5e7eb;
        }
        
        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .cart-title {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .cart-count {
            background: #10b981;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        /* Product Grid */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .product-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .product-card:hover {
            border-color: #10b981;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
            transform: translateY(-2px);
        }
        
        .product-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 5px;
        }
        
        .product-sku {
            color: #6b7280;
            font-size: 12px;
            margin-bottom: 10px;
        }
        
        .product-price {
            font-size: 20px;
            font-weight: 700;
            color: #059669;
            margin-bottom: 10px;
        }
        
        .product-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quantity-control {
            display: flex;
            align-items: center;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .qty-btn {
            background: #f3f4f6;
            border: none;
            width: 35px;
            height: 35px;
            cursor: pointer;
            font-size: 18px;
            color: #374151;
            transition: all 0.3s;
        }
        
        .qty-btn:hover {
            background: #10b981;
            color: white;
        }
        
        .qty-input {
            width: 50px;
            border: none;
            text-align: center;
            font-weight: 600;
            padding: 0;
        }
        
        .add-to-cart-btn {
            flex: 1;
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .add-to-cart-btn:hover {
            background: #059669;
        }
        
        .add-to-cart-btn.in-cart {
            background: #ef4444;
        }
        
        /* Cart Items */
        .cart-items {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .cart-item-info {
            flex: 1;
        }
        
        .cart-item-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 5px;
        }
        
        .cart-item-details {
            color: #6b7280;
            font-size: 14px;
        }
        
        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .cart-item-total {
            font-weight: 600;
            color: #059669;
            font-size: 18px;
            min-width: 100px;
            text-align: right;
        }
        
        .remove-item-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }
        
        /* Cart Summary */
        .cart-summary {
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            padding: 20px;
            border-radius: 12px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 16px;
        }
        
        .summary-row.shipping-info {
            background: #fef3c7;
            padding: 10px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .summary-row.total {
            font-size: 24px;
            font-weight: 700;
            color: #059669;
            padding-top: 15px;
            border-top: 2px solid #d1d5db;
        }
        
        /* Navigation Buttons */
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            flex: 1;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
        }
        
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Loading and Messages */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
        }
        
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .message {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            animation: slideDown 0.3s;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        
        .message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        
        /* Order Summary */
        .order-review {
            background: #f9fafb;
            padding: 25px;
            border-radius: 12px;
        }
        
        .review-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .review-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .review-title {
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 10px;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }
        
        .review-content {
            color: #1f2937;
        }
        
        .products-list {
            margin-top: 10px;
        }
        
        .product-line {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #e5e7eb;
        }
        
        .product-line:last-child {
            border-bottom: none;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .products-grid {
                grid-template-columns: 1fr;
            }
            
            .stepper {
                flex-direction: column;
                gap: 20px;
            }
            
            .step {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🛍️ Sistema de Pedidos HBX</h1>
            <p>Portal Exclusivo para Distribuidores</p>
        </div>
        
        <!-- Stepper -->
        <div class="stepper">
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <div class="step-title">Información Personal</div>
            </div>
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <div class="step-title">Dirección de Envío</div>
            </div>
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div class="step-title">Selección de Productos</div>
            </div>
            <div class="step" id="step4">
                <div class="step-number">4</div>
                <div class="step-title">Confirmación</div>
            </div>
        </div>
        
        <div class="form-container">
            <form id="orderForm">
                <!-- PASO 1: Información Personal -->
                <div class="form-section active" id="section1">
                    <div class="section-content">
                        <h2 class="section-title">
                            <span>👤</span>
                            Información del Distribuidor
                        </h2>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="distributorId">ID de Distribuidor <span class="required">*</span></label>
                                <input type="text" id="distributorId" name="distributorId" required>
                                <div class="error-message">Este campo es obligatorio</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="fullName">Nombre Completo <span class="required">*</span></label>
                                <input type="text" id="fullName" name="fullName" required>
                                <div class="error-message">Por favor ingrese su nombre completo</div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="email">Correo Electrónico <span class="required">*</span></label>
                                <input type="email" id="email" name="email" required>
                                <div class="error-message">Ingrese un correo válido</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="phone">Teléfono (10 dígitos) <span class="required">*</span></label>
                                <input type="tel" id="phone" name="phone" pattern="[0-9]{10}" required>
                                <div class="error-message">Ingrese 10 dígitos sin espacios</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="nav-buttons">
                        <div></div>
                        <button type="button" class="btn btn-primary" onclick="nextStep(1)">
                            Continuar
                            <span>→</span>
                        </button>
                    </div>
                </div>
                
                <!-- PASO 2: Dirección de Envío -->
                <div class="form-section" id="section2">
                    <div class="section-content">
                        <h2 class="section-title">
                            <span>📍</span>
                            Dirección de Envío
                        </h2>
                        
                        <div class="map-search-container">
                            <span class="search-icon">🔍</span>
                            <input type="text" id="searchAddress" placeholder="Busca tu dirección aquí...">
                        </div>
                        
                        <div id="map"></div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="state">Estado <span class="required">*</span></label>
                                <input type="text" id="state" name="state" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="city">Ciudad <span class="required">*</span></label>
                                <input type="text" id="city" name="city" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="street">Calle y Número <span class="required">*</span></label>
                                <input type="text" id="street" name="street" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="colony">Colonia <span class="required">*</span></label>
                                <input type="text" id="colony" name="colony" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="zipCode">Código Postal <span class="required">*</span></label>
                                <input type="text" id="zipCode" name="zipCode" pattern="[0-9]{5}" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="receiver">Persona que recibe <span class="required">*</span></label>
                                <input type="text" id="receiver" name="receiver" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="addressNotes">Referencias adicionales (opcional)</label>
                            <textarea id="addressNotes" name="addressNotes" rows="2" placeholder="Entre calles, color de casa, etc."></textarea>
                        </div>
                    </div>
                    
                    <div class="nav-buttons">
                        <button type="button" class="btn btn-secondary" onclick="previousStep(2)">
                            <span>←</span>
                            Anterior
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextStep(2)">
                            Continuar
                            <span>→</span>
                        </button>
                    </div>
                </div>
                
                <!-- PASO 3: Selección de Productos -->
                <div class="form-section" id="section3">
                    <div class="section-content">
                        <h2 class="section-title">
                            <span>🛒</span>
                            Selección de Productos
                        </h2>
                        
                        <div class="products-grid" id="productsGrid">
                            <!-- Los productos se cargarán aquí dinámicamente -->
                        </div>
                    </div>
                    
                    <div class="cart-container">
                        <div class="cart-header">
                            <div class="cart-title">📦 Tu Pedido</div>
                            <div class="cart-count" id="cartCount">0 productos</div>
                        </div>
                        
                        <div class="cart-items" id="cartItems">
                            <p style="text-align: center; color: #6b7280; padding: 20px;">
                                No hay productos en el carrito
                            </p>
                        </div>
                        
                        <div class="cart-summary" id="cartSummary" style="display: none;">
                            <div class="summary-row">
                                <span>Subtotal:</span>
                                <strong id="subtotal">$0.00</strong>
                            </div>
                            
                            <div class="summary-row shipping-info">
                                <div>
                                    <div>Costo de envío:</div>
                                    <small style="color: #92400e;">
                                        <span id="numGuias">1</span> guía(s) necesaria(s)
                                    </small>
                                </div>
                                <strong id="shippingCost">$200.00</strong>
                            </div>
                            
                            <div class="summary-row total">
                                <span>TOTAL:</span>
                                <span id="totalCost">$200.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="nav-buttons">
                        <button type="button" class="btn btn-secondary" onclick="previousStep(3)">
                            <span>←</span>
                            Anterior
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextStep(3)" id="continueToReview" disabled>
                            Revisar Pedido
                            <span>→</span>
                        </button>
                    </div>
                </div>
                
                <!-- PASO 4: Confirmación -->
                <div class="form-section" id="section4">
                    <div class="order-review">
                        <h2 class="section-title">
                            <span>✅</span>
                            Confirma tu Pedido
                        </h2>
                        
                        <div class="review-section">
                            <div class="review-title">Información del Distribuidor</div>
                            <div class="review-content" id="reviewPersonal"></div>
                        </div>
                        
                        <div class="review-section">
                            <div class="review-title">Dirección de Envío</div>
                            <div class="review-content" id="reviewAddress"></div>
                        </div>
                        
                        <div class="review-section">
                            <div class="review-title">Productos Seleccionados</div>
                            <div class="review-content">
                                <div class="products-list" id="reviewProducts"></div>
                            </div>
                        </div>
                        
                        <div class="review-section">
                            <div class="review-title">Resumen de Costos</div>
                            <div class="review-content" id="reviewCosts"></div>
                        </div>
                    </div>
                    
                    <div class="nav-buttons">
                        <button type="button" class="btn btn-secondary" onclick="previousStep(4)">
                            <span>←</span>
                            Modificar
                        </button>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <span>📤</span>
                            Confirmar y Enviar Pedido
                        </button>
                    </div>
                </div>
                
                <!-- Mensajes -->
                <div class="message success" id="successMessage">
                    ✅ ¡Pedido enviado exitosamente! Recibirás un correo de confirmación.
                </div>
                
                <div class="message error" id="errorMessage">
                    ❌ Error al procesar el pedido. Por favor intenta nuevamente.
                </div>
            </form>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3>Procesando tu pedido...</h3>
            <p>Por favor espera un momento</p>
        </div>
    </div>
    
    <script>
        // ========== CONFIGURACIÓN ==========
        // IMPORTANTE: Cambia esta URL por la de tu webhook en n8n
        const WEBHOOK_URL = 'https://tu-instancia-n8n.com/webhook/pedidos-hbx';
        
        // Productos disponibles
        const PRODUCTOS = [
            {id: 1, nombre: "Ajo Negro", sku: "34-01", precio: 339},
            {id: 2, nombre: "Aler-max", sku: "30A", precio: 385},
            {id: 3, nombre: "Atri Plus", sku: "02-03", precio: 380},
            {id: 4, nombre: "Alex", sku: "17", precio: 249},
            {id: 5, nombre: "Biotina + Ácido hialurónico", sku: "71E", precio: 459},
            {id: 6, nombre: "Brioreal Max", sku: "8A-01", precio: 259},
            {id: 7, nombre: "Cilco-Life", sku: "36A-03", precio: 280},
            {id: 8, nombre: "Cloriloe", sku: "47-05", precio: 415},
            {id: 9, nombre: "Cobex", sku: "3", precio: 255},
            {id: 10, nombre: "Colágeno Hidrolizado", sku: "71C-05", precio: 595},
            {id: 11, nombre: "Colágeno Plus", sku: "71C-07", precio: 479},
            {id: 12, nombre: "Debet", sku: "6", precio: 255},
            {id: 13, nombre: "Dexel Plus Keto", sku: "5D-09", precio: 539},
            {id: 14, nombre: "Dexel Plus", sku: "5D-11", precio: 479},
            {id: 15, nombre: "Difest", sku: "1", precio: 339},
            {id: 16, nombre: "Domix", sku: "18-06", precio: 275},
            {id: 17, nombre: "Donox", sku: "13", precio: 280},
            {id: 18, nombre: "Enerbax Coffee", sku: "57", precio: 545},
            {id: 19, nombre: "Femsy", sku: "20C", precio: 290},
            {id: 20, nombre: "FIMAX", sku: "42-02", precio: 415},
            {id: 21, nombre: "Gatiloe", sku: "10-04", precio: 479},
            {id: 22, nombre: "Gip", sku: "21", precio: 345},
            {id: 23, nombre: "Herbalance", sku: "59", precio: 255},
            {id: 24, nombre: "Hipen", sku: "11", precio: 255},
            {id: 25, nombre: "Hivy", sku: "25", precio: 255},
            {id: 26, nombre: "Indi", sku: "7", precio: 259},
            {id: 27, nombre: "Jugo Verde", sku: "38-02", precio: 579},
            {id: 28, nombre: "Labrin", sku: "33A", precio: 279},
            {id: 29, nombre: "Lactilostro", sku: "48", precio: 429},
            {id: 30, nombre: "Lasy", sku: "12", precio: 280},
            {id: 31, nombre: "LongLife", sku: "4A", precio: 339},
            {id: 32, nombre: "Macromega con ajo", sku: "52A-03", precio: 395},
            {id: 33, nombre: "Magne-Forte", sku: "14A-05", precio: 375},
            {id: 34, nombre: "Magnotun 131", sku: "31", precio: 835},
            {id: 35, nombre: "Magnotun 7s", sku: "131A-03", precio: 729},
            {id: 36, nombre: "Magnotun cap", sku: "3105-01", precio: 479},
            {id: 37, nombre: "Moringa", sku: "66-01", precio: 269},
            {id: 38, nombre: "Nutravit Vainilla", sku: "51E", precio: 819},
            {id: 39, nombre: "Obix-te", sku: "15C-04", precio: 579},
            {id: 40, nombre: "Oxyvit Resveratrol", sku: "68B-01", precio: 355},
            {id: 41, nombre: "Palax", sku: "23", precio: 249},
            {id: 42, nombre: "Plosan", sku: "40-04", precio: 280},
            {id: 43, nombre: "Rim", sku: "26", precio: 255},
            {id: 44, nombre: "Sabila", sku: "69-02", precio: 565},
            {id: 45, nombre: "Stevy", sku: "60", precio: 270},
            {id: 46, nombre: "Ternosan", sku: "44", precio: 355},
            {id: 47, nombre: "Tesy", sku: "9", precio: 249},
            {id: 48, nombre: "Total Fem", sku: "59F", precio: 345},
            {id: 49, nombre: "Total Men", sku: "59M", precio: 345},
            {id: 50, nombre: "Vanix-Roydes", sku: "28", precio: 280},
            {id: 51, nombre: "Vinagre de Manzana", sku: "15D", precio: 369},
            {id: 52, nombre: "Visan", sku: "VISAN", precio: 255},
            {id: 53, nombre: "Vitamina C", sku: "1A", precio: 259}
        ];
        
        // ========== ESTADO GLOBAL ==========
        let currentStep = 1;
        let cart = [];
        let map = null;
        let marker = null;
        let geocoder = null;
        let autocomplete = null;
        let orderData = {};
        
        // ========== INICIALIZACIÓN ==========
        window.onload = function() {
            loadProducts();
            setupEventListeners();
        };
        
        // ========== NAVEGACIÓN ==========
        function nextStep(step) {
            if (!validateStep(step)) {
                return;
            }
            
            // Guardar datos del paso actual
            saveStepData(step);
            
            // Marcar paso como completado
            document.getElementById(`step${step}`).classList.add('completed');
            document.getElementById(`step${step}`).classList.remove('active');
            
            // Activar siguiente paso
            currentStep = step + 1;
            document.getElementById(`step${currentStep}`).classList.add('active');
            
            // Mostrar sección correspondiente
            document.querySelectorAll('.form-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(`section${currentStep}`).classList.add('active');
            
            // Si es el paso de confirmación, mostrar resumen
            if (currentStep === 4) {
                showOrderReview();
            }
            
            // Scroll al top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function previousStep(step) {
            // Desactivar paso actual
            document.getElementById(`step${step}`).classList.remove('active');
            
            // Activar paso anterior
            currentStep = step - 1;
            document.getElementById(`step${currentStep}`).classList.add('active');
            document.getElementById(`step${currentStep}`).classList.remove('completed');
            
            // Mostrar sección correspondiente
            document.querySelectorAll('.form-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(`section${currentStep}`).classList.add('active');
            
            // Scroll al top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // ========== VALIDACIÓN ==========
        function validateStep(step) {
            let isValid = true;
            
            if (step === 1) {
                // Validar información personal
                const fields = ['distributorId', 'fullName', 'email', 'phone'];
                fields.forEach(field => {
                    const input = document.getElementById(field);
                    if (!input.value) {
                        input.classList.add('error');
                        input.nextElementSibling.style.display = 'block';
                        isValid = false;
                    } else {
                        input.classList.remove('error');
                        input.nextElementSibling.style.display = 'none';
                    }
                });
                
                // Validar formato de email
                const email = document.getElementById('email');
                if (email.value && !email.value.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
                    email.classList.add('error');
                    email.nextElementSibling.style.display = 'block';
                    isValid = false;
                }
                
                // Validar teléfono (10 dígitos)
                const phone = document.getElementById('phone');
                if (phone.value && !phone.value.match(/^[0-9]{10}$/)) {
                    phone.classList.add('error');
                    phone.nextElementSibling.style.display = 'block';
                    isValid = false;
                }
            }
            
            if (step === 2) {
                // Validar dirección
                const fields = ['state', 'city', 'street', 'colony', 'zipCode', 'receiver'];
                fields.forEach(field => {
                    const input = document.getElementById(field);
                    if (!input.value) {
                        input.classList.add('error');
                        isValid = false;
                    } else {
                        input.classList.remove('error');
                    }
                });
                
                // Validar código postal (5 dígitos)
                const zipCode = document.getElementById('zipCode');
                if (zipCode.value && !zipCode.value.match(/^[0-9]{5}$/)) {
                    zipCode.classList.add('error');
                    isValid = false;
                }
                
                if (!isValid) {
                    alert('Por favor complete todos los campos de dirección correctamente');
                }
            }
            
            if (step === 3) {
                // Validar que haya al menos un producto en el carrito
                if (cart.length === 0) {
                    alert('Por favor agregue al menos un producto al carrito');
                    isValid = false;
                }
            }
            
            return isValid;
        }
        
        // ========== GUARDAR DATOS ==========
        function saveStepData(step) {
            if (step === 1) {
                orderData.distribuidor = {
                    id: document.getElementById('distributorId').value,
                    nombre: document.getElementById('fullName').value,
                    email: document.getElementById('email').value,
                    telefono: document.getElementById('phone').value
                };
            }
            
            if (step === 2) {
                orderData.direccion = {
                    estado: document.getElementById('state').value,
                    ciudad: document.getElementById('city').value,
                    calle: document.getElementById('street').value,
                    colonia: document.getElementById('colony').value,
                    codigoPostal: document.getElementById('zipCode').value,
                    receptor: document.getElementById('receiver').value,
                    referencias: document.getElementById('addressNotes').value,
                    coordenadas: marker ? {
                        lat: marker.getPosition().lat(),
                        lng: marker.getPosition().lng()
                    } : null
                };
            }
            
            if (step === 3) {
                orderData.productos = cart;
                orderData.totales = calculateTotals();
            }
        }
        
        // ========== PRODUCTOS ==========
        function loadProducts() {
            const grid = document.getElementById('productsGrid');
            
            PRODUCTOS.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <div class="product-name">${product.nombre}</div>
                    <div class="product-sku">SKU: ${product.sku}</div>
                    <div class="product-price">$${product.precio.toFixed(2)}</div>
                    <div class="product-controls">
                        <div class="quantity-control">
                            <button class="qty-btn" onclick="changeQuantity(${product.id}, -1)">-</button>
                            <input type="number" class="qty-input" id="qty-${product.id}" value="1" min="1" max="99" onchange="updateQuantity(${product.id})">
                            <button class="qty-btn" onclick="changeQuantity(${product.id}, 1)">+</button>
                        </div>
                        <button class="add-to-cart-btn" id="btn-${product.id}" onclick="toggleCart(${product.id})">
                            Agregar
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        
        function changeQuantity(productId, change) {
            const input = document.getElementById(`qty-${productId}`);
            let value = parseInt(input.value) || 1;
            value = Math.max(1, Math.min(99, value + change));
            input.value = value;
            
            // Si el producto está en el carrito, actualizar
            const cartItem = cart.find(item => item.id === productId);
            if (cartItem) {
                cartItem.cantidad = value;
                updateCart();
            }
        }
        
        function updateQuantity(productId) {
            const input = document.getElementById(`qty-${productId}`);
            let value = parseInt(input.value) || 1;
            value = Math.max(1, Math.min(99, value));
            input.value = value;
            
            // Si el producto está en el carrito, actualizar
            const cartItem = cart.find(item => item.id === productId);
            if (cartItem) {
                cartItem.cantidad = value;
                updateCart();
            }
        }
        
        function toggleCart(productId) {
            const product = PRODUCTOS.find(p => p.id === productId);
            const quantity = parseInt(document.getElementById(`qty-${productId}`).value) || 1;
            const button = document.getElementById(`btn-${productId}`);
            
            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                // Remover del carrito
                cart = cart.filter(item => item.id !== productId);
                button.textContent = 'Agregar';
                button.classList.remove('in-cart');
            } else {
                // Agregar al carrito
                cart.push({
                    ...product,
                    cantidad: quantity
                });
                button.textContent = 'Quitar';
                button.classList.add('in-cart');
            }
            
            updateCart();
        }
        
        // ========== CARRITO ==========
        function updateCart() {
            const cartItems = document.getElementById('cartItems');
            const cartCount = document.getElementById('cartCount');
            const cartSummary = document.getElementById('cartSummary');
            const continueBtn = document.getElementById('continueToReview');
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">No hay productos en el carrito</p>';
                cartSummary.style.display = 'none';
                continueBtn.disabled = true;
                cartCount.textContent = '0 productos';
            } else {
                let itemsHtml = '';
                cart.forEach(item => {
                    itemsHtml += `
                        <div class="cart-item">
                            <div class="cart-item-info">
                                <div class="cart-item-name">${item.nombre}</div>
                                <div class="cart-item-details">
                                    SKU: ${item.sku} | $${item.precio} x ${item.cantidad}
                                </div>
                            </div>
                            <div class="cart-item-controls">
                                <div class="cart-item-total">$${(item.precio * item.cantidad).toFixed(2)}</div>
                                <button class="remove-item-btn" onclick="removeFromCart(${item.id})">Quitar</button>
                            </div>
                        </div>
                    `;
                });
                cartItems.innerHTML = itemsHtml;
                cartSummary.style.display = 'block';
                continueBtn.disabled = false;
                
                // Actualizar conteo
                const totalItems = cart.reduce((sum, item) => sum + item.cantidad, 0);
                cartCount.textContent = `${totalItems} producto${totalItems !== 1 ? 's' : ''}`;
                
                // Actualizar totales
                updateTotals();
            }
        }
        
        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            
            // Actualizar botón del producto
            const button = document.getElementById(`btn-${productId}`);
            if (button) {
                button.textContent = 'Agregar';
                button.classList.remove('in-cart');
            }
            
            updateCart();
        }
        
        function calculateTotals() {
            let subtotal = 0;
            cart.forEach(item => {
                subtotal += item.precio * item.cantidad;
            });
            
            // Calcular costo de envío
            let costoEnvio = 200;
            let numeroGuias = 1;
            
            if (subtotal <= 8000) {
                costoEnvio = 200;
                numeroGuias = 1;
            } else if (subtotal <= 16000) {
                costoEnvio = 400;
                numeroGuias = 2;
            } else if (subtotal <= 24000) {
                costoEnvio = 600;
                numeroGuias = 3;
            } else if (subtotal <= 32000) {
                costoEnvio = 800;
                numeroGuias = 4;
            } else if (subtotal <= 40000) {
                costoEnvio = 1000;
                numeroGuias = 5;
            } else if (subtotal <= 48000) {
                costoEnvio = 1200;
                numeroGuias = 6;
            } else {
                numeroGuias = Math.ceil(subtotal / 8000);
                costoEnvio = numeroGuias * 200;
            }
            
            return {
                subtotal: subtotal,
                costoEnvio: costoEnvio,
                numeroGuias: numeroGuias,
                total: subtotal + costoEnvio
            };
        }
        
        function updateTotals() {
            const totals = calculateTotals();
            
            document.getElementById('subtotal').textContent = `$${totals.subtotal.toFixed(2)}`;
            document.getElementById('shippingCost').textContent = `$${totals.costoEnvio.toFixed(2)}`;
            document.getElementById('numGuias').textContent = totals.numeroGuias;
            document.getElementById('totalCost').textContent = `$${totals.total.toFixed(2)}`;
        }
        
        // ========== GOOGLE MAPS ==========
        function initMap() {
            // Centro de México
            const mexico = { lat: 19.432608, lng: -99.133209 };
            
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 6,
                center: mexico,
                mapTypeControl: false,
                streetViewControl: false
            });
            
            marker = new google.maps.Marker({
                position: mexico,
                map: map,
                draggable: true,
                animation: google.maps.Animation.DROP
            });
            
            geocoder = new google.maps.Geocoder();
            
            // Configurar autocompletado
            const searchBox = document.getElementById('searchAddress');
            autocomplete = new google.maps.places.Autocomplete(searchBox, {
                componentRestrictions: { country: 'mx' },
                fields: ['address_components', 'geometry', 'formatted_address']
            });
            
            autocomplete.addListener('place_changed', function() {
                const place = autocomplete.getPlace();
                
                if (!place.geometry) {
                    alert('No se encontró la dirección');
                    return;
                }
                
                // Mover mapa y marcador
                map.setCenter(place.geometry.location);
                map.setZoom(17);
                marker.setPosition(place.geometry.location);
                
                // Llenar campos de dirección
                fillAddressFields(place);
            });
            
            // Cuando se mueve el marcador
            marker.addListener('dragend', function() {
                geocodePosition(marker.getPosition());
            });
            
            // Click en el mapa
            map.addListener('click', function(event) {
                marker.setPosition(event.latLng);
                geocodePosition(event.latLng);
            });
        }
        
        function geocodePosition(pos) {
            geocoder.geocode({
                latLng: pos
            }, function(responses) {
                if (responses && responses.length > 0) {
                    fillAddressFields(responses[0]);
                    document.getElementById('searchAddress').value = responses[0].formatted_address;
                }
            });
        }
        
        function fillAddressFields(place) {
            // Limpiar campos primero
            const fields = ['state', 'city', 'street', 'colony', 'zipCode'];
            fields.forEach(field => {
                document.getElementById(field).value = '';
            });
            
            let streetNumber = '';
            let route = '';
            
            // Procesar componentes de dirección
            if (place.address_components) {
                place.address_components.forEach(component => {
                    const type = component.types[0];
                    
                    switch(type) {
                        case 'street_number':
                            streetNumber = component.long_name;
                            break;
                        case 'route':
                            route = component.long_name;
                            break;
                        case 'sublocality_level_1':
                        case 'neighborhood':
                            document.getElementById('colony').value = component.long_name;
                            break;
                        case 'locality':
                        case 'administrative_area_level_2':
                            document.getElementById('city').value = component.long_name;
                            break;
                        case 'administrative_area_level_1':
                            document.getElementById('state').value = component.long_name;
                            break;
                        case 'postal_code':
                            document.getElementById('zipCode').value = component.short_name;
                            break;
                    }
                });
                
                // Combinar calle y número
                if (route) {
                    const streetField = streetNumber ? `${route} ${streetNumber}` : route;
                    document.getElementById('street').value = streetField;
                }
            }
        }
        
        // ========== RESUMEN DE PEDIDO ==========
        function showOrderReview() {
            // Información personal
            const personalHtml = `
                <p><strong>ID:</strong> ${orderData.distribuidor.id}</p>
                <p><strong>Nombre:</strong> ${orderData.distribuidor.nombre}</p>
                <p><strong>Email:</strong> ${orderData.distribuidor.email}</p>
                <p><strong>Teléfono:</strong> ${orderData.distribuidor.telefono}</p>
            `;
            document.getElementById('reviewPersonal').innerHTML = personalHtml;
            
            // Dirección
            const addressHtml = `
                <p>${orderData.direccion.calle}, ${orderData.direccion.colonia}</p>
                <p>${orderData.direccion.ciudad}, ${orderData.direccion.estado}</p>
                <p>C.P. ${orderData.direccion.codigoPostal}</p>
                <p><strong>Recibe:</strong> ${orderData.direccion.receptor}</p>
                ${orderData.direccion.referencias ? `<p><strong>Referencias:</strong> ${orderData.direccion.referencias}</p>` : ''}
            `;
            document.getElementById('reviewAddress').innerHTML = addressHtml;
            
            // Productos
            let productsHtml = '';
            orderData.productos.forEach(item => {
                productsHtml += `
                    <div class="product-line">
                        <span>${item.nombre} (${item.cantidad} unidades)</span>
                        <span>$${(item.precio * item.cantidad).toFixed(2)}</span>
                    </div>
                `;
            });
            document.getElementById('reviewProducts').innerHTML = productsHtml;
            
            // Costos
            const costsHtml = `
                <div class="product-line">
                    <span>Subtotal:</span>
                    <strong>$${orderData.totales.subtotal.toFixed(2)}</strong>
                </div>
                <div class="product-line">
                    <span>Envío (${orderData.totales.numeroGuias} guía${orderData.totales.numeroGuias > 1 ? 's' : ''}):</span>
                    <strong>$${orderData.totales.costoEnvio.toFixed(2)}</strong>
                </div>
                <div class="product-line" style="font-size: 20px; color: #059669; font-weight: 700; padding-top: 10px;">
                    <span>TOTAL:</span>
                    <span>$${orderData.totales.total.toFixed(2)}</span>
                </div>
            `;
            document.getElementById('reviewCosts').innerHTML = costsHtml;
        }
        
        // ========== ENVÍO DE FORMULARIO ==========
        function setupEventListeners() {
            document.getElementById('orderForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Mostrar loading
                document.getElementById('loadingOverlay').style.display = 'flex';
                
                // Preparar datos finales
                const finalData = {
                    numeroPedido: `HBX-${Date.now()}`,
                    timestamp: new Date().toISOString(),
                    distribuidor: orderData.distribuidor,
                    direccion: orderData.direccion,
                    productos: orderData.productos,
                    totales: orderData.totales
                };
                
                try {
                    // Enviar a n8n webhook
                    const response = await fetch(WEBHOOK_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(finalData)
                    });
                    
                    if (response.ok) {
                        // Ocultar loading
                        document.getElementById('loadingOverlay').style.display = 'none';
                        
                        // Mostrar mensaje de éxito
                        document.getElementById('successMessage').style.display = 'block';
                        
                        // Deshabilitar botón de envío
                        document.getElementById('submitBtn').disabled = true;
                        
                        // Limpiar carrito
                        cart = [];
                        
                        // Redirigir o limpiar después de 3 segundos
                        setTimeout(() => {
                            // Opción 1: Recargar la página
                            window.location.reload();
                            
                            // Opción 2: Redirigir a página de agradecimiento
                            // window.location.href = '/gracias';
                        }, 3000);
                    } else {
                        throw new Error('Error en el servidor');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    
                    // Ocultar loading
                    document.getElementById('loadingOverlay').style.display = 'none';
                    
                    // Mostrar mensaje de error
                    document.getElementById('errorMessage').style.display = 'block';
                    
                    setTimeout(() => {
                        document.getElementById('errorMessage').style.display = 'none';
                    }, 5000);
                }
            });
        }
    </script>
    
    <!-- Google Maps API -->
    <!-- IMPORTANTE: Reemplaza TU_API_KEY con tu clave real de Google Maps -->
    <script async defer 
        src="https://maps.googleapis.com/maps/api/js?key=TU_API_KEY&libraries=places&callback=initMap">
    </script>
</body>
</html>