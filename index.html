<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Sistema de Pedidos HBX - Portal Distribuidores</title>
  <meta name="description" content="Portal de pedidos para distribuidores HBX." />
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--bg1:#667eea;--bg2:#764ba2;--green:#10b981;--green-700:#059669;--slate-900:#111827;--slate-800:#1f2937;--slate-700:#374151;--slate-600:#4b5563;--slate-500:#6b7280;--slate-300:#d1d5db;--slate-200:#e5e7eb;--slate-100:#f3f4f6;--slate-50:#f9fafb;--red:#ef4444}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));min-height:100vh;padding:20px;color:var(--slate-800)}
    .container{max-width:1000px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden}
    .header{background:linear-gradient(135deg,#059669,#10b981);color:#fff;padding:40px 30px;text-align:center}
    .header h1{font-size:32px;margin-bottom:10px;font-weight:700}
    .stepper{display:flex;justify-content:center;gap:20px;padding:30px;background:var(--slate-50);border-bottom:2px solid var(--slate-200);flex-wrap:wrap}
    .step{display:flex;align-items:center;gap:10px}
    .step-number{width:40px;height:40px;border-radius:50%;background:var(--slate-200);color:var(--slate-500);display:flex;align-items:center;justify-content:center;font-weight:600;transition:.3s}
    .step-title{font-weight:500;color:var(--slate-500)}
    .step.active .step-number{background:var(--green);color:#fff}
    .step.completed .step-number{background:var(--green-700);color:#fff}
    .step.active .step-title{color:var(--green);font-weight:600}
    .form-container{padding:30px}
    .form-section{display:none;animation:fadeIn .3s}
    .form-section.active{display:block}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .section-content{background:var(--slate-50);padding:25px;border-radius:12px;margin-bottom:20px}
    .section-title{font-size:24px;font-weight:600;color:var(--slate-800);margin-bottom:20px;display:flex;align-items:center;gap:10px}
    .form-group{margin-bottom:20px}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    label{display:block;margin-bottom:8px;color:var(--slate-700);font-weight:500;font-size:14px}
    input,select,textarea{width:100%;padding:12px 16px;border:2px solid var(--slate-200);border-radius:8px;font-size:16px;transition:.3s;background:#fff}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--green);box-shadow:0 0 0 3px rgba(16,185,129,.12)}
    input.error,select.error{border-color:var(--red)}
    .error-message{color:var(--red);font-size:13px;margin-top:5px;display:none}
    .hint{font-size:13px;color:var(--slate-600);margin-top:6px}
    .warning{background:#fff7ed;border:1px solid #fed7aa;color:#92400e;padding:10px 12px;border-radius:8px;margin-top:10px;display:none}
    .required{color:var(--red)}
    .products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px;margin-bottom:30px}
    .product-card{background:#fff;border:2px solid var(--slate-200);border-radius:12px;padding:15px;transition:.3s;cursor:pointer}
    .product-card:hover{border-color:var(--green);box-shadow:0 4px 12px rgba(16,185,129,.15);transform:translateY(-2px)}
    .product-name{font-weight:600;color:var(--slate-800);margin-bottom:5px}
    .product-sku{color:var(--slate-500);font-size:12px;margin-bottom:10px}
    .product-price{font-size:20px;font-weight:700;color:var(--green-700);margin-bottom:10px}
    .product-controls{display:flex;align-items:center;gap:10px}
    .quantity-control{display:flex;align-items:center;border:2px solid var(--slate-200);border-radius:8px;overflow:hidden}
    .qty-btn{background:var(--slate-100);border:none;width:35px;height:35px;cursor:pointer;font-size:18px;color:var(--slate-700);transition:.2s}
    .qty-btn:hover{background:var(--green);color:#fff}
    .qty-input{width:50px;border:none;text-align:center;font-weight:600;padding:0}
    .add-to-cart-btn{flex:1;background:var(--green);color:#fff;border:none;padding:8px 16px;border-radius:8px;font-weight:600;cursor:pointer;transition:.2s}
    .add-to-cart-btn:hover{background:var(--green-700)}
    .add-to-cart-btn.in-cart{background:var(--red)}
    .cart-container{background:#fff;border-radius:12px;padding:20px;border:2px solid var(--slate-200)}
    .cart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid var(--slate-200)}
    .cart-title{font-size:20px;font-weight:600;color:var(--slate-800)}
    .cart-count{background:var(--green);color:#fff;padding:5px 12px;border-radius:20px;font-size:14px;font-weight:600}
    .cart-items{max-height:400px;overflow-y:auto;margin-bottom:20px}
    .cart-item{display:flex;justify-content:space-between;align-items:center;padding:15px;background:var(--slate-50);border-radius:8px;margin-bottom:10px}
    .cart-item-info{flex:1}
    .cart-item-name{font-weight:600;color:var(--slate-800);margin-bottom:5px}
    .cart-item-details{color:var(--slate-500);font-size:14px}
    .cart-item-controls{display:flex;align-items:center;gap:15px}
    .cart-item-total{font-weight:600;color:var(--green-700);font-size:18px;min-width:100px;text-align:right}
    .remove-item-btn{background:var(--red);color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px}
    .cart-summary{background:linear-gradient(135deg,var(--slate-50),var(--slate-100));padding:20px;border-radius:12px}
    .summary-row{display:flex;justify-content:space-between;margin-bottom:12px;font-size:16px}
    .summary-row.shipping-info{background:#fef3c7;padding:10px;border-radius:8px;margin:15px 0}
    .summary-row.total{font-size:24px;font-weight:700;color:var(--green-700);padding-top:15px;border-top:2px solid var(--slate-300)}
    .nav-buttons{display:flex;justify-content:space-between;gap:20px;margin-top:30px}
    .btn{padding:14px 28px;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;transition:.2s;border:none;display:inline-flex;align-items:center;gap:8px}
    .btn-secondary{background:var(--slate-100);color:var(--slate-700)}
    .btn-secondary:hover{background:var(--slate-200)}
    .btn-primary{background:linear-gradient(135deg,#10b981,#059669);color:#fff;flex:1}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(16,185,129,.3)}
    .btn:disabled{background:#9ca3af;cursor:not-allowed;transform:none}
    .loading-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:9999;justify-content:center;align-items:center}
    .loading-content{background:#fff;padding:40px;border-radius:20px;text-align:center}
    .spinner{border:4px solid var(--slate-100);border-top:4px solid var(--green);border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 20px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .message{padding:15px 20px;border-radius:10px;margin-bottom:20px;display:none;animation:slideDown .3s}
    @keyframes slideDown{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
    .message.success{background:#d1fae5;color:#065f46;border:1px solid var(--green)}
    .message.error{background:#fee2e2;color:#991b1b;border:1px solid var(--red)}
    .order-review{background:var(--slate-50);padding:25px;border-radius:12px}
    .review-section{margin-bottom:25px;padding-bottom:20px;border-bottom:1px solid var(--slate-200)}
    .review-section:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
    .review-title{font-weight:600;color:var(--slate-500);margin-bottom:10px;text-transform:uppercase;font-size:12px;letter-spacing:.5px}
    .review-content{color:var(--slate-800)}
    .products-list{margin-top:10px}
    .product-line{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed var(--slate-200)}
    .product-line:last-child{border-bottom:none}
    @media (max-width:768px){.form-row{grid-template-columns:1fr}.products-grid{grid-template-columns:1fr}.stepper{flex-direction:column;gap:20px}.step{width:100%}}
  </style>
</head>
<body>
  <noscript>Necesitas habilitar JavaScript para usar este portal.</noscript>

  <div class="container" role="main">
    <div class="header">
      <h1>üõçÔ∏è Sistema de Pedidos HBX</h1>
      <p>Portal Exclusivo para Distribuidores</p>
    </div>

    <div class="stepper" aria-label="Progreso del pedido">
      <div class="step active" id="step1"><div class="step-number">1</div><div class="step-title">Informaci√≥n Personal</div></div>
      <div class="step" id="step2"><div class="step-number">2</div><div class="step-title">Direcci√≥n de Env√≠o</div></div>
      <div class="step" id="step3"><div class="step-number">3</div><div class="step-title">Selecci√≥n de Productos</div></div>
      <div class="step" id="step4"><div class="step-number">4</div><div class="step-title">Confirmaci√≥n</div></div>
    </div>

    <div class="form-container">
      <form id="orderForm" autocomplete="on">
        <!-- PASO 1 -->
        <div class="form-section active" id="section1">
          <div class="section-content">
            <h2 class="section-title"><span>üë§</span>Informaci√≥n del Distribuidor</h2>

            <div class="form-row">
              <div class="form-group">
                <label for="distributorId">ID de Distribuidor <span class="required">*</span></label>
                <input type="text" id="distributorId" required />
                <div class="error-message">Este campo es obligatorio</div>
              </div>
              <div class="form-group">
                <label for="fullName">Nombre Completo <span class="required">*</span></label>
                <input type="text" id="fullName" required />
                <div class="error-message">Por favor ingrese su nombre completo</div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="email">Correo Electr√≥nico <span class="required">*</span></label>
                <input type="email" id="email" required />
                <div class="error-message">Ingrese un correo v√°lido</div>
              </div>
              <div class="form-group">
                <label for="phone">Tel√©fono (10 d√≠gitos) <span class="required">*</span></label>
                <input type="tel" id="phone" inputmode="numeric" required />
                <div class="error-message">Ingresa al menos 10 d√≠gitos (acepta +52, guiones y espacios)</div>
              </div>
            </div>
          </div>

          <div class="nav-buttons">
            <div></div>
            <button type="button" class="btn btn-primary" id="btnToStep2">Continuar ‚Üí</button>
          </div>
        </div>

        <!-- PASO 2 -->
        <div class="form-section" id="section2">
          <div class="section-content">
            <h2 class="section-title"><span>üì¶</span>Direcci√≥n de Env√≠o</h2>

            <div class="form-row">
              <div class="form-group">
                <label for="zipCode">C√≥digo Postal (5 d√≠gitos) <span class="required">*</span></label>
                <input type="text" id="zipCode" required />
                <div class="error-message">Ingrese 5 d√≠gitos</div>
                <div class="hint">Si hay token de Copomex, autocompletamos Municipio/Colonias; si no, captura manual.</div>
                <div class="warning" id="zipWarning"></div>
              </div>
              <div class="form-group">
                <label for="state">Estado <span class="required">*</span></label>
                <input type="text" id="state" required />
                <div class="error-message">Campo obligatorio</div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="city">Municipio/Alcald√≠a <span class="required">*</span></label>
                <input type="text" id="city" required />
                <div class="error-message">Campo obligatorio</div>
              </div>

              <div class="form-group" id="colonyGroup">
                <label for="colony">Colonia/Fracc. <span class="required">*</span></label>
                <input type="text" id="colony" required />
                <select id="colonySelect" style="display:none;"></select>
                <div class="error-message">Campo obligatorio</div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="street">Calle y N√∫mero <span class="required">*</span></label>
                <input type="text" id="street" required />
                <div class="error-message">Campo obligatorio</div>
              </div>
              <div class="form-group">
                <label for="receiver">Persona que recibe <span class="required">*</span></label>
                <input type="text" id="receiver" required />
                <div class="error-message">Campo obligatorio</div>
              </div>
            </div>

            <div class="form-group">
              <label for="addressNotes">Referencias adicionales (opcional)</label>
              <textarea id="addressNotes" rows="2" placeholder="Entre calles, color de casa, punto de referencia‚Ä¶"></textarea>
            </div>
          </div>

          <div class="nav-buttons">
            <button type="button" class="btn btn-secondary" id="btnBackTo1">‚Üê Anterior</button>
            <button type="button" class="btn btn-primary" id="btnToStep3">Continuar ‚Üí</button>
          </div>
        </div>

        <!-- PASO 3 -->
        <div class="form-section" id="section3">
          <div class="section-content">
            <h2 class="section-title"><span>üõí</span>Selecci√≥n de Productos</h2>
            <div class="products-grid" id="productsGrid"></div>
          </div>

          <div class="cart-container">
            <div class="cart-header">
              <div class="cart-title">üì¶ Tu Pedido</div>
              <div class="cart-count" id="cartCount">0 productos</div>
            </div>

            <div class="cart-items" id="cartItems">
              <p style="text-align:center; color:var(--slate-500); padding:20px;">No hay productos en el carrito</p>
            </div>

            <div class="cart-summary" id="cartSummary" style="display:none;">
              <div class="summary-row"><span>Subtotal:</span><strong id="subtotal">$0.00</strong></div>
              <div class="summary-row shipping-info">
                <div>
                  <div>Costo de env√≠o:</div>
                  <small style="color:#92400e;"><span id="numGuias">1</span> gu√≠a(s) necesaria(s)</small>
                </div>
                <strong id="shippingCost">$200.00</strong>
              </div>
              <div class="summary-row total"><span>TOTAL:</span><span id="totalCost">$200.00</span></div>
            </div>
          </div>

          <div class="nav-buttons">
            <button type="button" class="btn btn-secondary" id="btnBackTo2">‚Üê Anterior</button>
            <button type="button" class="btn btn-primary" id="continueToReview" disabled>Revisar Pedido ‚Üí</button>
          </div>
        </div>

        <!-- PASO 4 -->
        <div class="form-section" id="section4">
          <div class="order-review">
            <h2 class="section-title"><span>‚úÖ</span>Confirma tu Pedido</h2>

            <div class="review-section">
              <div class="review-title">Informaci√≥n del Distribuidor</div>
              <div class="review-content" id="reviewPersonal"></div>
            </div>

            <div class="review-section">
              <div class="review-title">Direcci√≥n de Env√≠o</div>
              <div class="review-content" id="reviewAddress"></div>
            </div>

            <div class="review-section">
              <div class="review-title">Productos Seleccionados</div>
              <div class="review-content"><div class="products-list" id="reviewProducts"></div></div>
            </div>

            <div class="review-section">
              <div class="review-title">Resumen de Costos</div>
              <div class="review-content" id="reviewCosts"></div>
            </div>
          </div>

          <div class="nav-buttons">
            <button type="button" class="btn btn-secondary" id="btnBackTo3">‚Üê Modificar</button>
            <button type="submit" class="btn btn-primary" id="submitBtn">üì§ Confirmar y Enviar Pedido</button>
          </div>
        </div>

        <div class="message success" id="successMessage">‚úÖ ¬°Pedido enviado exitosamente! Recibir√°s un correo de confirmaci√≥n.</div>
        <div class="message error" id="errorMessage">‚ùå Error al procesar el pedido. Por favor intenta nuevamente.</div>
      </form>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay" aria-live="polite">
    <div class="loading-content">
      <div class="spinner"></div>
      <h3>Procesando tu pedido...</h3>
      <p>Por favor espera un momento</p>
    </div>
  </div>

  <script>
    /* ================= CONFIG ================= */
    const WEBHOOK_URL = window.HBX_WEBHOOK_URL || "https://arkamiadorno.app.n8n.cloud/webhook/pedidos-hbx";
    const COPOMEX_TOKEN = window.COPOMEX_TOKEN || "";
    const CP_STATE_PREFIX = {"00":"CDMX","01":"Aguascalientes","02":"Baja California","03":"Baja California Sur","04":"Campeche","05":"Coahuila","06":"Colima","07":"Chiapas","08":"Chihuahua","09":"CDMX","10":"Durango","11":"Guanajuato","12":"Guerrero","13":"Hidalgo","14":"Jalisco","15":"Edomex","16":"Michoac√°n","17":"Morelos","18":"Nayarit","19":"Nuevo Le√≥n","20":"Oaxaca","21":"Puebla","22":"Quer√©taro","23":"Quintana Roo","24":"San Luis Potos√≠","25":"Sinaloa","26":"Sonora","27":"Tabasco","28":"Tamaulipas","29":"Tlaxcala","30":"Veracruz","31":"Yucat√°n","32":"Zacatecas"};
    function copomexUrl(cp){return `https://api.copomex.com/query/info_cp/${encodeURIComponent(cp)}?type=simplified&token=${encodeURIComponent(COPOMEX_TOKEN)}`;}

    /* Productos (recorta o extiende a gusto) */
    const PRODUCTOS=[{id:1,nombre:"Ajo Negro",sku:"34-01",precio:339},{id:2,nombre:"Aler-max",sku:"30A",precio:385},{id:3,nombre:"Atri Plus",sku:"02-03",precio:380},{id:4,nombre:"Alex",sku:"17",precio:249},{id:5,nombre:"Biotina + √Åcido hialur√≥nico",sku:"71E",precio:459},{id:6,nombre:"Brioreal Max",sku:"8A-01",precio:259},{id:7,nombre:"Cilco-Life",sku:"36A-03",precio:280},{id:8,nombre:"Cloriloe",sku:"47-05",precio:415},{id:9,nombre:"Cobex",sku:"3",precio:255},{id:10,nombre:"Col√°geno Hidrolizado",sku:"71C-05",precio:595}];

    let currentStep=1, cart=[], orderData={}, lastCpQueried=null;
    document.addEventListener("DOMContentLoaded",()=>{loadProducts();wireButtons();wireSepomex();});

    /* ---- Navegaci√≥n ---- */
    function goToStep(next){
      document.getElementById(`step${currentStep}`).classList.remove("active");
      document.getElementById(`section${currentStep}`).classList.remove("active");
      if(next>currentStep){document.getElementById(`step${currentStep}`).classList.add("completed");}
      else{document.getElementById(`step${currentStep}`).classList.remove("completed");}
      currentStep=next;
      document.getElementById(`step${currentStep}`).classList.add("active");
      document.getElementById(`section${currentStep}`).classList.add("active");
      window.scrollTo({top:0,behavior:"smooth"});
      if(currentStep===4) showOrderReview();
    }
    function wireButtons(){
      document.getElementById("btnToStep2").addEventListener("click",()=>{ if(validateStep1()){ saveStep1(); goToStep(2);} });
      document.getElementById("btnBackTo1").addEventListener("click",()=>goToStep(1));
      document.getElementById("btnToStep3").addEventListener("click",()=>{ if(validateStep2()){ saveStep2(); goToStep(3);} });
      document.getElementById("btnBackTo2").addEventListener("click",()=>goToStep(2));
      document.getElementById("continueToReview").addEventListener("click",()=>{ if(validateStep3()){ saveStep3(); goToStep(4);} });
      document.getElementById("btnBackTo3").addEventListener("click",()=>goToStep(3));
      document.getElementById("orderForm").addEventListener("submit",onSubmit);
    }

    /* ---- SEPOMEX ---- */
    function wireSepomex(){
      const zip=document.getElementById("zipCode");
      zip.addEventListener("change",onZipChange);
      zip.addEventListener("blur",onZipChange);
      const colonySelect=document.getElementById("colonySelect");
      colonySelect.addEventListener("change",()=>{ if(colonySelect.style.display!=="none"){ document.getElementById("colony").value=colonySelect.value||""; } });
    }
    async function onZipChange(){
      const cp=(document.getElementById("zipCode").value||"").trim();
      const warn=document.getElementById("zipWarning"); warn.style.display="none"; warn.textContent="";
      if(!/^[0-9]{5}$/.test(cp)) return;
      const prefix=cp.slice(0,2), expectedState=CP_STATE_PREFIX[prefix]||null;

      if(COPOMEX_TOKEN){
        if(cp===lastCpQueried) return; lastCpQueried=cp;
        try{
          const r=await fetch(copomexUrl(cp)); if(!r.ok) throw new Error("HTTP "+r.status);
          const data=await r.json();
          const info=data&&(data.response||data[0]||data);
          const estado=(info.estado||info.estado_nombre||info.Estado||"").toString();
          const municipio=(info.municipio||info.municipio_nombre||info.Municipio||"").toString();
          let colonias=info.asentamientos||info.colonias||info.Asentamientos||[];
          if(Array.isArray(data)&&!info.asentamientos){ colonias=data.map(x=>x.asentamiento||x.Asentamiento||x.colonia||"").filter(Boolean); }
          if(estado) document.getElementById("state").value=estado;
          if(municipio) document.getElementById("city").value=municipio;
          if(Array.isArray(colonias)&&colonias.length>0){ setColonySelect(colonias); } else { resetColonyToInput(); }
          if(expectedState&&estado&&normal(estado)!==normal(expectedState)){ warn.textContent=`Advertencia: el CP ${cp} suele corresponder a "${expectedState}", pero la API devolvi√≥ "${estado}". Verifica.`; warn.style.display="block"; }
        }catch(_e){
          resetColonyToInput();
          if(expectedState){
            const st=document.getElementById("state");
            if(st.value && normal(st.value)!==normal(expectedState)){ warn.textContent=`Advertencia: por prefijo de CP, el estado esperado es "${expectedState}".`; warn.style.display="block"; }
          }
        }
      }else{
        resetColonyToInput();
        if(expectedState){
          const st=document.getElementById("state");
          if(!st.value){ st.value=expectedState; }
          else if(normal(st.value)!==normal(expectedState)){ warn.textContent=`Advertencia: por prefijo de CP, el estado esperado es "${expectedState}".`; warn.style.display="block"; }
        }
      }
    }
    function normal(s){return (s||"").toString().trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"")}
    function setColonySelect(colonias){
      const inp=document.getElementById("colony"); const sel=document.getElementById("colonySelect");
      sel.innerHTML=`<option value="">Selecciona tu colonia‚Ä¶</option>`+colonias.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
      sel.style.display="block"; inp.style.display="none"; inp.required=false; sel.required=true;
    }
    function resetColonyToInput(){
      const inp=document.getElementById("colony"); const sel=document.getElementById("colonySelect");
      sel.style.display="none"; inp.style.display="block"; sel.required=false; inp.required=true;
    }
    function escapeHtml(str){return (str||"").toString().replace(/[&<>"']/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]))}

    /* ---- Validaciones ---- */
    function digits(s){return (s||"").replace(/\D+/g,"");}
    function validateStep1(){
      let ok=true;
      ["distributorId","fullName","email","phone"].forEach(id=>{
        const el=document.getElementById(id), v=(el.value||"").trim();
        if(!v){ el.classList.add("error"); el.nextElementSibling && (el.nextElementSibling.style.display="block"); ok=false; }
        else{ el.classList.remove("error"); el.nextElementSibling && (el.nextElementSibling.style.display="none"); }
      });
      const email=document.getElementById("email"), e=(email.value||"").trim();
      if(e && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)){ email.classList.add("error"); email.nextElementSibling&&(email.nextElementSibling.textContent="Correo no v√°lido",email.nextElementSibling.style.display="block"); ok=false; }
      const phone=document.getElementById("phone"), d=digits(phone.value);
      if(d.length<10){ phone.classList.add("error"); phone.nextElementSibling&&(phone.nextElementSibling.textContent="Ingresa al menos 10 d√≠gitos (puede incluir +52, guiones o espacios)",phone.nextElementSibling.style.display="block"); ok=false; }
      else{ phone.classList.remove("error"); phone.nextElementSibling&&(phone.nextElementSibling.style.display="none"); phone.value=d.slice(-10); }
      return ok;
    }
    function validateStep2(){
      let ok=true;
      ["state","city","street","receiver","zipCode"].forEach(id=>{
        const el=document.getElementById(id);
        if(!el.value.trim()){ markError(el,true); ok=false; } else { markError(el,false); }
      });
      const zip=document.getElementById("zipCode");
      if(zip.value && !/^[0-9]{5}$/.test(zip.value)){ markError(zip,true); ok=false; }
      const selVisible=document.getElementById("colonySelect").style.display!=="none";
      if(selVisible){
        const sel=document.getElementById("colonySelect");
        if(!sel.value){ sel.classList.add("error"); ok=false; } else { sel.classList.remove("error"); }
      }else{
        const inp=document.getElementById("colony");
        if(!inp.value.trim()){ markError(inp,true); ok=false; } else { markError(inp,false); }
      }
      if(!ok) alert("Por favor completa todos los campos de direcci√≥n correctamente");
      return ok;
    }
    function validateStep3(){ if(cart.length===0){ alert("Por favor agrega al menos un producto al carrito"); return false;} return true; }
    function markError(el,on){const msg=el.nextElementSibling&&el.nextElementSibling.classList.contains("error-message")?el.nextElementSibling:null; if(on){el.classList.add("error"); if(msg) msg.style.display="block";} else {el.classList.remove("error"); if(msg) msg.style.display="none";}}

    /* ---- Guardado ---- */
    function saveStep1(){ orderData.distribuidor={ id:distributorId.value.trim(), nombre:fullName.value.trim(), email:email.value.trim(), telefono:phone.value.trim() }; }
    function saveStep2(){
      const colonySelectVisible=document.getElementById("colonySelect").style.display!=="none";
      const colonia=colonySelectVisible?document.getElementById("colonySelect").value:document.getElementById("colony").value.trim();
      orderData.direccion={ codigoPostal:zipCode.value.trim(), estado:state.value.trim(), ciudad:city.value.trim(), colonia, calle:street.value.trim(), receptor:receiver.value.trim(), referencias:addressNotes.value.trim() };
    }
    function saveStep3(){ orderData.productos=cart; orderData.totales=calculateTotals(); }

    /* ---- Productos ---- */
    function loadProducts(){
      const grid=document.getElementById("productsGrid"); grid.innerHTML="";
      PRODUCTOS.forEach(p=>{
        const card=document.createElement("div"); card.className="product-card";
        card.innerHTML=`
          <div class="product-name">${p.nombre}</div>
          <div class="product-sku">SKU: ${p.sku}</div>
          <div class="product-price">$${p.precio.toFixed(2)}</div>
          <div class="product-controls">
            <div class="quantity-control">
              <button type="button" class="qty-btn" aria-label="Disminuir" onclick="changeQuantity(${p.id},-1)">-</button>
              <input type="number" class="qty-input" id="qty-${p.id}" value="1" min="1" max="99" onchange="updateQuantity(${p.id})">
              <button type="button" class="qty-btn" aria-label="Aumentar" onclick="changeQuantity(${p.id},1)">+</button>
            </div>
            <button type="button" class="add-to-cart-btn" id="btn-${p.id}" onclick="toggleCart(${p.id})">Agregar</button>
          </div>`;
        grid.appendChild(card);
      });
      window.changeQuantity=changeQuantity; window.updateQuantity=updateQuantity; window.toggleCart=toggleCart; window.removeFromCart=removeFromCart;
    }
    function changeQuantity(id,delta){const input=document.getElementById(`qty-${id}`); let v=parseInt(input.value)||1; v=Math.max(1,Math.min(99,v+delta)); input.value=v; const it=cart.find(i=>i.id===id); if(it){it.cantidad=v; updateCart();}}
    function updateQuantity(id){const input=document.getElementById(`qty-${id}`); let v=Math.max(1,Math.min(99,parseInt(input.value)||1)); input.value=v; const it=cart.find(i=>i.id===id); if(it){it.cantidad=v; updateCart();}}
    function toggleCart(id){
      const p=PRODUCTOS.find(x=>x.id===id); const qty=parseInt(document.getElementById(`qty-${id}`).value)||1; const btn=document.getElementById(`btn-${id}`); const ex=cart.find(i=>i.id===id);
      if(ex){ cart=cart.filter(i=>i.id!==id); btn.textContent="Agregar"; btn.classList.remove("in-cart"); }
      else{ cart.push({...p,cantidad:qty}); btn.textContent="Quitar"; btn.classList.add("in-cart"); }
      updateCart();
    }
    function updateCart(){
      const items=document.getElementById("cartItems"), count=document.getElementById("cartCount"), summary=document.getElementById("cartSummary"), review=document.getElementById("continueToReview");
      if(cart.length===0){ items.innerHTML='<p style="text-align:center; color:var(--slate-500); padding:20px;">No hay productos en el carrito</p>'; summary.style.display="none"; review.disabled=true; count.textContent="0 productos"; return; }
      items.innerHTML=cart.map(i=>`
        <div class="cart-item">
          <div class="cart-item-info">
            <div class="cart-item-name">${i.nombre}</div>
            <div class="cart-item-details">SKU: ${i.sku} | $${i.precio} x ${i.cantidad}</div>
          </div>
          <div class="cart-item-controls">
            <div class="cart-item-total">$${(i.precio*i.cantidad).toFixed(2)}</div>
            <button type="button" class="remove-item-btn" onclick="removeFromCart(${i.id})">Quitar</button>
          </div>
        </div>`).join("");
      summary.style.display="block"; review.disabled=false;
      const totalItems=cart.reduce((s,i)=>s+i.cantidad,0); count.textContent=`${totalItems} producto${totalItems!==1?'s':''}`;
      updateTotals();
    }
    function removeFromCart(id){ cart=cart.filter(i=>i.id!==id); const btn=document.getElementById(`btn-${id}`); if(btn){btn.textContent="Agregar"; btn.classList.remove("in-cart");} updateCart(); }

    /* ---- Totales & Review ---- */
    function calculateTotals(){ const subtotal=cart.reduce((s,i)=>s+i.precio*i.cantidad,0); const guias=Math.max(1,Math.ceil(subtotal/8000)); const envio=guias*200; return {subtotal,costoEnvio:envio,numeroGuias:guias,total:subtotal+envio}; }
    function updateTotals(){ const t=calculateTotals(); subtotal.textContent=`$${t.subtotal.toFixed(2)}`; shippingCost.textContent=`$${t.costoEnvio.toFixed(2)}`; numGuias.textContent=t.numeroGuias; totalCost.textContent=`$${t.total.toFixed(2)}`; }

    function showOrderReview(){
      const p=orderData.distribuidor, d=orderData.direccion, t=orderData.totales;
      reviewPersonal.innerHTML = `
        <p><strong>ID:</strong> ${p.id}</p>
        <p><strong>Nombre:</strong> ${p.nombre}</p>
        <p><strong>Email:</strong> ${p.email}</p>
        <p><strong>Tel√©fono:</strong> ${p.telefono}</p>`;
      reviewAddress.innerHTML = `
        <p>${d.calle}, ${d.colonia}</p>
        <p>${d.ciudad}, ${d.estado}</p>
        <p>C.P. ${d.codigoPostal}</p>
        <p><strong>Recibe:</strong> ${d.receptor}</p>
        ${d.referencias ? `<p><strong>Referencias:</strong> ${d.referencias}</p>` : ""}`;
      reviewProducts.innerHTML = orderData.productos.map(i=>`
        <div class="product-line">
          <span>${i.nombre} (${i.cantidad} unidades)</span>
          <span>$${(i.precio*i.cantidad).toFixed(2)}</span>
        </div>`).join("");
      reviewCosts.innerHTML = `
        <div class="product-line"><span>Subtotal:</span><strong>$${t.subtotal.toFixed(2)}</strong></div>
        <div class="product-line"><span>Env√≠o (${t.numeroGuias} gu√≠a${t.numeroGuias>1?'s':''}):</span><strong>$${t.costoEnvio.toFixed(2)}</strong></div>
        <div class="product-line" style="font-size:20px;color:#059669;font-weight:700;padding-top:10px;">
          <span>TOTAL:</span><span>$${t.total.toFixed(2)}</span>
        </div>`;
    }

    /* ---- Submit ---- */
    async function onSubmit(e){
      e.preventDefault();
      document.getElementById("loadingOverlay").style.display="flex";
      const payload={ numeroPedido:`HBX-${Date.now()}`, timestamp:new Date().toISOString(), distribuidor:orderData.distribuidor, direccion:orderData.direccion, productos:orderData.productos, totales:orderData.totales };
      try{
        const res=await fetch(WEBHOOK_URL,{ method:"POST", headers:{"Content-Type":"application/json"}, mode:"cors", body:JSON.stringify(payload) });
        document.getElementById("loadingOverlay").style.display="none";
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        document.getElementById("successMessage").style.display="block";
        document.getElementById("submitBtn").disabled=true;
        cart=[]; setTimeout(()=>window.location.reload(),2500);
      }catch(err){
        console.error(err); document.getElementById("loadingOverlay").style.display="none";
        document.getElementById("errorMessage").style.display="block"; setTimeout(()=>document.getElementById("errorMessage").style.display="none",5000);
      }
    }
  </script>
</body>
</html>
